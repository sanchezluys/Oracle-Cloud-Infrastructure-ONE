## Conectando una API y la base de datos.


### Conociendo a Doguito API

- SODA:
- el codigo esta en nodejs


![alt doguito_bd](/imagenes/clase02/doguito_db.png)

### Implementando la API en OCI

- se accede a la instancia
- se verifica el valor de la ip publica de la instancia.
- se activa la cloud shell

```bash
    ssh opc@mi_ip_publica -i .ssh/cloudshellkey

    opc@dps-vm1:$   sudo dnf install git // para manejar el codigo y poder descargarlo a la instancia
                    git clone https://github.com/HarlandLohora/doguito-api-es    // para clonar el codigo del repo
                    ls  // se ve la carpeta doguito-api-es
                    sudo dnf install @nodejs:16 // instala node js version 16
                    cd doguito-api-es
                    ls // se ven los archivos ejemplo el package.json
                    npm install // para instalar las dependencias
                    npm start   // va a dar errores, es necesario instalar mas cosas, es decir dependencias o librerias pero de oracle

                    //***    */
                    sudo dnf list installed | grep instantclient 
                    sudo dnf install oracle-instantclient-release-e18
                    sudo dnf install oracle-instantclient-basic

                    //*** es necesario configurar la conexion TLS, para oracle mTLS*/
                    // se usa cartera de instancia en TLS
                    // se usa una clave por ejemplo doguito.2024

                    // luego es necesario llevar ese archivo al cloudshell
                    exit // para salir al clodshell

                    // una vez el archivo este en cloudshell es necesario llevarlo a la instancia, moverlo

                    scp -i .ssh/cloudshellkey wallet_doguito_db.zip opc@ip_instancia:/home/opc

                    //** vuelvo a ingresar a la instancia */
                    ssh opc@ip_inst -i .ssh/cloudshellkey
                    ls // deberian verse la carpeta de doguito y el zip que se movió para la instancia

                    //** ahora se lleva el archivo zip a la carpeta adecuada de la instancia */

                    sudo cp wallet_*.zip /usr/lib/oracle/21/client64/lib/network/admin

                    //** se verifica que este en ese directorio */

                    cd /usr/lib/oracle/21/client64/lib/network/admin
                    ls // se debe ver el zip

                    //** ahora es necesario descomprimir el archivo */
                    sudo unzip -B wallet_doguito.zip

                    //** se vuelve a doguito api */

                    cd doguito-api-es
                    npm start   // para iniciar de nuevo el proyecto
                                // ahora da el error de las credenciales para conectarse a la BD
                                // se necesitan las variables de entorno
                    
                    export DB_USER=ADMIN
                    export DB_PASSWORD=Doguito12345
                    export CONNECT_STRING=doguitodb_high


                    npm start // para iniciar de nuevo el proyecto, ahora si deberia iniciar


                    // pero en el navegador al ingresar la ip publica solo muestra el mensaje de doguito, al usar el puerto 3000 no hace nada
                    // es necesario habilitar el puerto 3000 en el firewall

                    sudo firewall-cmd --permanent --add-port=3000/tcp
                    sudo firewall-cmd --reload

                    npm start // inicia servidor, pero es necesario ajustar la subred publica de la instancia, VNIC primario

```

- mTLS en la BD

![alt tls_1](/imagenes/clase02/tls_1.png)

![alt tls_2](/imagenes/clase02/tls_2.png)

![alt tls_3](/imagenes/clase02/tls_3.png)

![alt tls_4](/imagenes/clase02/tls_4.png)

![alt tls_5](/imagenes/clase02/tls_5.png)

- cargando el archivo de clave, en el video es diferente donde se puede subir el archivo wallet_doguito_db.zip

![alt clave_1](/imagenes/clase02/clave_1.png)

![alt clave_2](/imagenes/clase02/clave_2.png)

- de donde sale CONNECT_STRING ?? las genera las conexiones a la BD, en nombre TNS

![alt clave_3](/imagenes/clase02/clave_3.png)

- servidor iniciado

![alt dog_1](/imagenes/clase02/dog_1.png)

- ajustar subred publica de la instancia

![alt sub_red_1](/imagenes/clase02/sub_red_1.png)

![alt sub_red_2](/imagenes/clase02/sub_red_2.png)

![alt sub_red_3](/imagenes/clase02/sub_red_3.png)

![alt sub_red_4](/imagenes/clase02/sub_red_4.png)

- ahora si, doguito api funcionando

![alt doguito_ok](/imagenes/clase02/doguito_ok.png)

- si deseo ver la lista de clientes, uso: http:ip_publica_instancia:3000/clientes

## En realidad, Oracle utiliza IDs hexadecimales para representar los objetos de la base de datos por varias razones:

- Eficiencia: Los IDs hexadecimales son más compactos que los enteros, lo que significa que ocupan menos espacio en la memoria y en el disco. Esto es importante para el rendimiento de la base de datos, especialmente cuando se trabaja con grandes cantidades de datos.

- Unicidad: Los IDs hexadecimales son más fáciles de generar de forma única que los enteros. Esto es importante para evitar colisiones de IDs, lo que podría causar problemas de integridad de datos.

- Compatibilidad: Los IDs hexadecimales son compatibles con la mayoría de los lenguajes de programación y sistemas operativos. Esto facilita la integración de Oracle con otras aplicaciones y sistemas.




Aprendimos cómo implementar una aplicación Node.JS en la infraestructura de OCI. Clonamos el repositorio de git de la aplicación en la instancia, en seguida instalamos Node.JS, drivers de base de datos y por fin liberamos firewall y la regla de entrada para que la aplicación fuera accesible.

Llegó la hora de que practiques lo que aprendiste y ejecutar la Doguito API en OCI. Para tener acceso a los códigos, puedes acceder al link del repositorio en Github.

https://github.com/alura-es-cursos/1911-OCI2-doguito-app


## Convirtiendo el servidor nodejs en un servicio de linux

- tomando en cuenta el archivo doguito-api.service

```bash
    ls  // se ve a doguito-api.service
    cat doguito-api.service // se muestra lo que tiene el archivo doguito-api.service

    // es necesario agregar las credencias en [service] del archivo

    // se puede usar vim

    vim doguito-api.service

    // i: insertar
    // flechas y buscar, y agregar las credenciales
    // esc : q  // para salir

    // mover el servicio a la carpeta del sistema
    sudo cp doguito-api.service /lib/systemd/system

    // recargar los servcios

    sudo systemctl daemon-reload

    // verificar el estado del servicio, si esta inactivo se debe activar

    sudo systemctl status doguito-api.service

    // activar servicio

    sudo systemctl start doguito-api.service

    // luego es necesario tener siempre habilitado el servicio

    sudo systemctl enable doguito-api.service

```


## Probando la API

- /clientes
- /clientes/id
- 

Para verificar los demas endpoints se puede usar postman, insomia o Advanced REST client (api client extension)

para crear un cliente

```json
    {
        "nombre":"antonio",
        "email":"antonio@gmail.com"
    }
```

probar con cada verbo, put, delete, get, post




Probamos la API REST de Doguito utilizando un plugin de navegador. Existen varias opciones de plugins de navegadores, pero utilizamos Boomerang, que está disponible en los enlaces abajo:

    Chrome, https://chrome.google.com/webstore/detail/boomerang-soap-rest-clien/eipdnjedkpcnlmmdfdkgfpljanehloah?hl=pt-BR
    Edge, https://microsoftedge.microsoft.com/addons/detail/boomerang-soap-rest-c/bhmdjpobkcdcompmlhiigoidknlgghfo

Si utilizas Firefox la única opción es RESTClient, https://addons.mozilla.org/pt-BR/firefox/addon/restclient/  (hoy 5/09/2024 no existe ese pluggin)

Pero vimos que la ejecución de Doguito es realizada de forma manual, lo que no es ideal una vez que si la instancia sea reiniciada o ocurrir algún problema, Doguito no será ejecutado otra vez. Para evitar este problema, convertimos Doguito en un servicio de Systemd.

Ahora es contigo, haga los ajustes recomendados y pruebe Doguito API con un cliente REST. Si tienes alguna dificultad, usa el fóro para conversar con otras personas sobre tus dudas.

Nuestra aplicación de ejemplo que será implementada en Oracle Cloud es desarrollada utilizando JavaScript, NodeJS y el framework Express. Para nuestro curso no será necesario conocimiento profundo de desarrollo de aplicaciones utilizando estas tecnologías, pues vamos a enfocarnos en la infraestructura de la implementación. 


Lo que aprendimos en esta aula:

    Que Doguito API es una aplicación que expone una API REST escrita en JavaScript utilizando framework Express.js y que es ejecutada por Node.js.
    Que es necesario instalar git para clonar nuestro proyecto para instancia, además de ser necesario instalar Node para ejecutar Doguito API y otros drivers de base de datos específicos de Oracle.
    Que hacemos la descarga de Wallet de la conexión de base de datos para que nuestra instancia pueda acceder al DOGUITOBD.
    Que podemos crear un servicio de systemd para que la aplicación de Doguito API inicie automáticamente con nuestra instancia.
    Que es necesario liberar el acceso a la puerta 3000 en firewall de la instancias y crear una regla de acceso en la lista de seguridad de red virtual para que podamos acceder al Doguito API.
    Que podemos utilizar un cliente REST como Boomerang para acceder nuestra API del Doguito